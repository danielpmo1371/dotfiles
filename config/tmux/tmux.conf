############################################
# TMUX Configuration with TPM and Plugins #
############################################

# ==========================
# General Settings
# ==========================

# Use Ctrl+e as prefix (based on running config)
set -g prefix C-e
unbind C-b
bind C-e send-prefix

# Enable mouse support
set -g mouse on

# Set default terminal
set -g default-terminal "tmux-256color"

# Increase history limit
set -g history-limit 50000

# No delay for escape key
set -g escape-time 0

# Disable Ctrl+d detach (conflicts with vim navigation)
unbind -n C-d

# Enable focus events
set -g focus-events on

# Increase display time
set -g display-time 4000

# Status refresh interval
set -g status-interval 1

# Set bar on top
set-option -g status-position top

# ==========================
# Copy Mode & Clipboard
# ==========================

# Vi-style copy keys
set -g mode-keys vi

# Enable clipboard
set -g set-clipboard on

# Copy-mode on "[" after prefix
bind -T prefix [ copy-mode
bind C-e copy-mode

# WSL clipboard integration
if-shell 'grep -q Microsoft /proc/version' {
  bind -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel "clip.exe"
  bind -T copy-mode     Enter send-keys -X copy-pipe-and-cancel "clip.exe"
  bind -T copy-mode-vi y     send-keys -X copy-pipe-and-cancel "clip.exe"
}

# ==========================
# Pane Navigation (Vim-style)
# ==========================

# With prefix
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Without prefix (Ctrl+h,j,k,l)
bind -n C-h select-pane -L
bind -n C-j select-pane -D
bind -n C-k select-pane -U
bind -n C-l select-pane -R

# Pane splitting with better keys
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# ==========================
# Window Management
# ==========================

# Start windows and panes at 1, not 0
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Navigate to previous/next window with Cmd+[ and ] (Ghostty sends Shift+Arrow sequences)
bind -n S-Left previous-window
bind -n S-Right next-window

# Move window left/right with Cmd+Shift+[ and ] (Ghostty sends Ctrl+Shift+Arrow sequences)
bind -n C-S-Left swap-window -t -1\; select-window -t -1
bind -n C-S-Right swap-window -t +1\; select-window -t +1

# Switch sessions with Cmd+Shift+j/k (Ghostty sends Shift+Arrow sequences)
bind -n S-Down switch-client -n
bind -n S-Up switch-client -p

# ==========================
# Theme and Appearance
# ==========================

# These will be overridden by tmux-power theme, but set defaults
set -g status-bg '#262626'
set -g status-fg '#626262'
set -g message-style "fg=#ffb86c,bg=#262626"
set -g message-command-style "fg=#ffb86c,bg=#262626"
set -g display-panes-active-colour '#ffb86c'
set -g display-panes-colour '#444444'

# ==========================
# TPM Plugin Manager
# ==========================

# Set plugin path (required for headless plugin installation)
set-environment -g TMUX_PLUGIN_MANAGER_PATH '~/.tmux/plugins/'

# List of plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'

# Gruvbox theme
set -g @plugin 'egel/tmux-gruvbox'
set -g @tmux-gruvbox 'dark' # or 'light'

# Session management
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# Floating window
# set -g @plugin 'omerxx/tmux-floax'

# Color tag
# set -g @plugin 'Determinant/tmux-colortag'

# Alternative themes (currently not active)
# set -g @plugin 'wfxr/tmux-power'
# set -g @tmux_power_theme 'gold'
# set -g @plugin 'catppuccin/tmux'

# ==========================
# Plugin Configuration
# ==========================

# Resurrect settings
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-vim 'session'
set -g @resurrect-strategy-nvim 'session'
set -g @resurrect-save-shell-history 'on'

# Continuum settings
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'

# Floax settings
# set -g @floax-width '80%'
# set -g @floax-height '80%'
# set -g @floax-border-color 'magenta'
# set -g @floax-text-color 'blue'
# set -g @floax-bind 'f'
# set -g @floax-bind-menu 'F'

# ==========================
# Key Bindings
# ==========================

# Reload config
bind r source-file ~/.tmux.conf \; display-message "Config reloaded!"

# Toggle synchronize panes
bind e setw synchronize-panes

# New session (prompts for name, then creates and switches to it)
bind N command-prompt -p "New session name:" "new-session -d -s '%%'; switch-client -t '%%'"

# Quick pane cycling
bind -n M-h select-pane -L
bind -n M-j select-pane -D
bind -n M-k select-pane -U
bind -n M-l select-pane -R

# Resize panes
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Claude Code popup toggle (Cmd+e Cmd+n to open/close, Cmd+e q to close from inside)
bind C-n run-shell "~/repos/dotfiles/util-scripts/tmux-claude-popup.sh"
bind q run-shell "~/repos/dotfiles/util-scripts/tmux-claude-popup.sh"

# Help popup (Cmd+e ?)
bind ? run-shell "~/repos/dotfiles/util-scripts/tmux-help-popup.sh"

# Corner pane toggle - Claude processes (Cmd+e Cmd+i to toggle)
bind C-i run-shell "~/repos/dotfiles/util-scripts/tmux-claude-corner.sh"
bind i run-shell "~/repos/dotfiles/util-scripts/tmux-claude-corner.sh"

# ==========================
# Initialize TPM
# ==========================
# Keep this line at the very bottom of tmux.conf
run '~/.tmux/plugins/tpm/tpm'
