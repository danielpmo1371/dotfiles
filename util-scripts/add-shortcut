#!/usr/bin/env bash

# add-shortcut (wrapper)
# Simplified external wrapper that encourages using the shell function form.
# When executed as a script, it REQUIRES the command to be passed explicitly.
# This avoids unreliable history scraping from a child process.

set -euo pipefail

SCRIPT_NAME="add-shortcut"

usage() {
  cat <<EOF
Usage:
  $SCRIPT_NAME <shortcut_name> "<command>"

Recommended:
  Source the function version to capture your last command reliably.
  See: add-shortcut.function.sh (add to your ~/.bashrc or ~/.zshrc)

Examples:
  $SCRIPT_NAME ll "ls -la"
EOF
}

# Append alias to appropriate rc file
create_alias_line() {
  local name="$1" cmd="$2" rc
  # pick rc based on the active shell
  case "${SHELL##*/}" in
    zsh) rc="$HOME/.zshrc" ;;
    bash|*) rc="$HOME/.bashrc" ;;
  esac
  # Escape single quotes for single-quoted alias value
  local esc
  esc=$(printf %s "$cmd" | sed "s/'/'\\''/g")
  printf "alias %s='%s'\n" "$name" "$esc" >> "$rc"
  printf "Created shortcut: %s -> %s\nAdded to: %s\n" "$name" "$cmd" "$rc"
  printf "To use now: source %s\n" "$rc"
}

main() {
  if [[ ${1:-} == "-h" || ${1:-} == "--help" || $# -lt 2 ]]; then
    usage
    exit $([[ $# -lt 2 ]] && echo 1 || echo 0)
  fi
  local name="$1" cmd="$2"
  if [[ ! "$name" =~ ^[A-Za-z0-9_-]+$ ]]; then
    echo "Error: shortcut name must be [A-Za-z0-9_-]" >&2
    exit 1
  fi
  create_alias_line "$name" "$cmd"
}

main "$@"
